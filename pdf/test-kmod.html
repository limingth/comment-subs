<h1 id="kmod-11-测试案例分析">kmod-11 测试案例分析</h1>
<h2 id="thu-12-1-编译-kmod-项目源码">THU-12-1 编译 kmod 项目源码</h2>
<h3 id="下载源码包">下载源码包</h3>
<pre><code>$ wget https://www.kernel.org/pub/linux/utils/kernel/kmod/kmod-11.tar.gz
--2013-06-18 01:08:47--  https://www.kernel.org/pub/linux/utils/kernel/kmod/kmod-11.tar.gz
Resolving www.kernel.org (www.kernel.org)... 149.20.4.69, 198.145.20.140
Connecting to www.kernel.org (www.kernel.org)|149.20.4.69|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 3458574 (3.3M) [application/x-gzip]
Saving to: `kmod-11.tar.gz&#39;

100%[======================================&gt;] 3,458,574    795K/s   in 5.3s    

2013-06-18 01:08:54 (641 KB/s) - `kmod-11.tar.gz&#39; saved [3458574/3458574]</code></pre>
<p>查看下载文件大小 3458574字节</p>
<pre><code>$ ls -l
total 3380
-rw-rw-r-- 1 akaedu akaedu 3458574 Nov  8  2012 kmod-11.tar.gz
$ </code></pre>
<h3 id="解压源码包">解压源码包</h3>
<pre><code>$ tar zxf kmod-11.tar.gz 
$ ls
kmod-11  kmod-11.tar.gz</code></pre>
<p>查看解压目录，可以统计出解压后文件数量 421个 $ cd kmod-11 $ find * | wc -l 421 $</p>
<h3 id="编译项目源码">编译项目源码</h3>
<pre><code>$ ./configure CFLAGS=&quot;-g -O2&quot; --prefix=/usr --sysconfdir=/etc --libdir=/usr/lib</code></pre>
<p>查看当前目录下文件数量 确认已经生成 Makefile</p>
<pre><code>$ find * | wc  -l
467
$ ls -l Makefile
-rw-rw-r-- 1 akaedu akaedu 91795 Jun 18 01:15 Makefile
$ make</code></pre>
<p>查看tools目录下生成的可执行文件</p>
<pre><code>$ ls ./tools/ -l |  grep &quot;x&quot;
lrwxrwxrwx 1 akaedu akaedu     10 Jun 18 01:17 depmod -&gt; kmod-nolib
lrwxrwxrwx 1 akaedu akaedu     10 Jun 18 01:17 insmod -&gt; kmod-nolib
-rwxrwxr-x 1 akaedu akaedu   8352 Jun 18 01:17 kmod
-rwxrwxr-x 1 akaedu akaedu 468079 Jun 18 01:17 kmod-nolib
lrwxrwxrwx 1 akaedu akaedu     10 Jun 18 01:17 lsmod -&gt; kmod-nolib
lrwxrwxrwx 1 akaedu akaedu     10 Jun 18 01:17 modinfo -&gt; kmod-nolib
lrwxrwxrwx 1 akaedu akaedu     10 Jun 18 01:17 modprobe -&gt; kmod-nolib
lrwxrwxrwx 1 akaedu akaedu     10 Jun 18 01:17 rmmod -&gt; kmod-nolib</code></pre>
<p>安装可执行文件</p>
<pre><code>$ make install
权限不够，需要 sudo

$ sudo make install
[sudo] password for akaedu: 
Making install in .
 /bin/mkdir -p &#39;/usr/lib&#39;
 /bin/bash ./libtool   --mode=install /usr/bin/install -c   libkmod/libkmod.la &#39;/usr/lib&#39;
libtool: install: /usr/bin/install -c libkmod/.libs/libkmod.so.2.2.1 /usr/lib/libkmod.so.2.2.1
libtool: install: (cd /usr/lib &amp;&amp; { ln -s -f libkmod.so.2.2.1 libkmod.so.2 || { rm -f libkmod.so.2 &amp;&amp; ln -s libkmod.so.2.2.1 libkmod.so.2; }; })
libtool: install: (cd /usr/lib &amp;&amp; { ln -s -f libkmod.so.2.2.1 libkmod.so || { rm -f libkmod.so &amp;&amp; ln -s libkmod.so.2.2.1 libkmod.so; }; })
libtool: install: /usr/bin/install -c libkmod/.libs/libkmod.lai /usr/lib/libkmod.la
libtool: finish: PATH=&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/sbin&quot; ldconfig -n /usr/lib
----------------------------------------------------------------------
Libraries have been installed in:
   /usr/lib

If you ever happen to want to link against installed libraries
in a given directory, LIBDIR, you must either use libtool, and
specify the full pathname of the library, or use the `-LLIBDIR&#39;
flag during linking and do at least one of the following:
   - add LIBDIR to the `LD_LIBRARY_PATH&#39; environment variable
     during execution
   - add LIBDIR to the `LD_RUN_PATH&#39; environment variable
     during linking
   - use the `-Wl,-rpath -Wl,LIBDIR&#39; linker flag
   - have your system administrator add LIBDIR to `/etc/ld.so.conf&#39;

See any operating system documentation about shared libraries for
more information, such as the ld(1) and ld.so(8) manual pages.
----------------------------------------------------------------------
 /bin/mkdir -p &#39;/usr/bin&#39;
  /bin/bash ./libtool   --mode=install /usr/bin/install -c tools/kmod &#39;/usr/bin&#39;
libtool: install: /usr/bin/install -c tools/.libs/kmod /usr/bin/kmod
make --no-print-directory install-exec-hook
if test &quot;/usr/lib&quot; != &quot;/usr/lib&quot;; then \
        /bin/mkdir -p /usr/lib &amp;&amp; \
        so_img_name=$(readlink /usr/lib/libkmod.so) &amp;&amp; \
        so_img_rel_target_prefix=$(echo /usr/lib | sed &#39;s,\(^/\|\)[^/][^/]*,..,g&#39;) &amp;&amp; \
        ln -sf $so_img_rel_target_prefix/usr/lib/$so_img_name /usr/lib/libkmod.so &amp;&amp; \
        mv /usr/lib/libkmod.so.* /usr/lib; \
    fi
 /bin/mkdir -p &#39;/usr/include&#39;
 /usr/bin/install -c -m 644 libkmod/libkmod.h &#39;/usr/include&#39;
 /bin/mkdir -p &#39;/usr/lib/pkgconfig&#39;
 /usr/bin/install -c -m 644 libkmod/libkmod.pc &#39;/usr/lib/pkgconfig&#39;
Making install in libkmod/docs
make[2]: Nothing to be done for `install-exec-am&#39;.
make[2]: Nothing to be done for `install-data-am&#39;.
Making install in man
make[2]: Nothing to be done for `install-exec-am&#39;.
 /bin/mkdir -p &#39;/usr/share/man/man5&#39;
 /usr/bin/install -c -m 644 depmod.d.5 modprobe.d.5 modules.dep.5 modules.dep.bin.5 &#39;/usr/share/man/man5&#39;
 /bin/mkdir -p &#39;/usr/share/man/man8&#39;
 /usr/bin/install -c -m 644 depmod.8 insmod.8 lsmod.8 rmmod.8 modprobe.8 modinfo.8 &#39;/usr/share/man/man8&#39;</code></pre>
<h2 id="thu-12-2-测试-kmod-命令">THU-12-2 测试 kmod 命令</h2>
<h3 id="运行-make-install-安装命令">运行 make install 安装命令</h3>
<pre><code>$ sudo make install</code></pre>
<h3 id="直接运行-kmod-命令">直接运行 kmod 命令</h3>
<pre><code>$ kmod
missing command
kmod - Manage kernel modules: list, load, unload, etc
Usage:
    kmod [options] command [command_options]

Options:
    -V, --version     show version
    -h, --help        show this help

Commands:
  help         Show help message
  list         list currently loaded modules

kmod also handles gracefully if called from following symlinks:
  lsmod        compat lsmod command
  rmmod        compat rmmod command
  insmod       compat insmod command
  modinfo      compat modinfo command
  modprobe     compat modprobe command
  depmod       compat depmod command</code></pre>
<h3 id="运行-kmod-help-命令">运行 kmod help 命令</h3>
<pre><code>$ kmod help
kmod - Manage kernel modules: list, load, unload, etc
Usage:
    help [options] command [command_options]

Options:
    -V, --version     show version
    -h, --help        show this help

Commands:
  help         Show help message
  list         list currently loaded modules

kmod also handles gracefully if called from following symlinks:
  lsmod        compat lsmod command
  rmmod        compat rmmod command
  insmod       compat insmod command
  modinfo      compat modinfo command
  modprobe     compat modprobe command
  depmod       compat depmod command
$ </code></pre>
<h3 id="运行-kmod-list-命令">运行 kmod list 命令</h3>
<pre><code>$ kmod list
Module                  Size  Used by
vmwgfx                102138  2 
ttm                    65344  1 vmwgfx
drm                   197692  3 ttm,vmwgfx
acpiphp                23535  0 
vmw_balloon            12700  0 
psmouse                72919  0 
serio_raw              13027  0 
joydev                 17393  0 
btusb                  17912  2 
i2c_piix4              13093  0 
mac_hid                13077  0 
shpchp                 32325  0 
bnep                   17830  2 
nfsd                  229850  13 
bluetooth             158438  10 bnep,btusb
nfs                   307376  0 
parport_pc             32114  1 
snd_ens1371            24819  2 
snd_ac97_codec        106082  1 snd_ens1371
ppdev                  12849  0 
ac97_bus               12642  1 snd_ac97_codec
gameport               15060  1 snd_ens1371
snd_rawmidi            25424  1 snd_ens1371
nfs_acl                12771  2 nfs,nfsd
auth_rpcgss            39597  2 nfs,nfsd
fscache                50642  1 nfs
snd_seq_device         14172  1 snd_rawmidi
snd_pcm                80845  2 snd_ac97_codec,snd_ens1371
lockd                  78804  2 nfs,nfsd
snd_page_alloc         14108  1 snd_pcm
snd_timer              28931  1 snd_pcm
sunrpc                205647  19 lockd,auth_rpcgss,nfs_acl,nfs,nfsd
snd                    62064  10 snd_timer,snd_pcm,snd_seq_device,snd_rawmidi,snd_ac97_codec,snd_ens1371
soundcore              14635  1 snd
lp                     17455  0 
parport                40930  3 lp,ppdev,parport_pc
pcnet32                41110  0 
usbhid                 41906  0 
floppy                 60310  0 
mptspi                 22474  2 
mptscsih               39530  1 mptspi
mptbase                96852  2 mptscsih,mptspi
hid                    77367  1 usbhid
vmw_pvscsi             18334  0 
vmxnet3                44924  0 
$ </code></pre>
<h3 id="kmod-11-版本中暂时不支持-loadunload-命令">kmod-11 版本中暂时不支持 load/unload 命令</h3>
<pre><code>$ kmod load
invalid command &#39;load&#39;
kmod - Manage kernel modules: list, load, unload, etc
Usage:
    kmod [options] command [command_options]

Options:
    -V, --version     show version
    -h, --help        show this help

Commands:
  help         Show help message
  list         list currently loaded modules

kmod also handles gracefully if called from following symlinks:
  lsmod        compat lsmod command
  rmmod        compat rmmod command
  insmod       compat insmod command
  modinfo      compat modinfo command
  modprobe     compat modprobe command
  depmod       compat depmod command</code></pre>
<h2 id="thu-12-3-测试-insmod-命令">THU-12-3 测试 insmod 命令</h2>
<h3 id="编写测试用内核模块源码-hello.c">编写测试用内核模块源码 hello.c</h3>
<pre><code>$ cat hello.c 

#include &lt;linux/module.h&gt;
#include &lt;linux/kernel.h&gt;

MODULE_AUTHOR(&quot;AKAEDU&quot;);
MODULE_DESCRIPTION(&quot;module example &quot;);
MODULE_LICENSE(&quot;GPL&quot;);

int global = 100;

int __init 
akae_init (void)
{
    int local = 200;
    printk (&quot;Hello, akaedu\n&quot;);

    printk(&quot;.text = %p\n&quot;, akae_init);
    printk(&quot;.data = %p\n&quot;, &amp;global);
    printk(&quot;.stack = %p\n&quot;, &amp;local);
    return 0;
}

void __exit
akae_exit (void)
{
    int local = 300;
    printk (&quot;module exit\n&quot;);

    printk(&quot;.text = %p\n&quot;, akae_exit);
    printk(&quot;.data = %p\n&quot;, &amp;global);
    printk(&quot;.stack = %p\n&quot;, &amp;local);
    return ;
}

module_init(akae_init);
module_exit(akae_exit);
$ </code></pre>
<h3 id="编写测试用内核模块的-makefile-文件">编写测试用内核模块的 Makefile 文件</h3>
<pre><code>$ cat Makefile 

obj-m := hello.o

KDIR := /usr/src/linux-headers-3.2.0-29-generic-pae/

all:
    make -C $(KDIR) SUBDIRS=$(PWD)  modules

clean:
    rm -rf *.o *.ko *.mod.* *.cmd 
    rm -rf .*

$ </code></pre>
<h3 id="编译内核模块-hello.ko">编译内核模块 hello.ko</h3>
<pre><code>$ cd hello-module/ 
$ make
make -C /usr/src/linux-headers-3.2.0-29-generic-pae/    SUBDIRS=/home/akaedu/Github/comment-subs/hello-module   modules
make[1]: Entering directory `/usr/src/linux-headers-3.2.0-29-generic-pae&#39;
  CC [M]  /home/akaedu/Github/comment-subs/hello-module/hello.o
  Building modules, stage 2.
  MODPOST 1 modules
  CC      /home/akaedu/Github/comment-subs/hello-module/hello.mod.o
  LD [M]  /home/akaedu/Github/comment-subs/hello-module/hello.ko
make[1]: Leaving directory `/usr/src/linux-headers-3.2.0-29-generic-pae&#39;
$ </code></pre>
<h3 id="使用测试用工具-insmod-插入内核模块">使用测试用工具 insmod 插入内核模块</h3>
<pre><code>$ sudo ./kmod-11/tools/insmod hello-module/hello.ko </code></pre>
<h3 id="查看插入内核模块后的打印结果">查看插入内核模块后的打印结果</h3>
<pre><code>$ lsmod | grep hello
hello                  12415  0 
$ dmesg | tail
[350775.859640] usb 2-2.1: USB disconnect, device number 14
[350777.611134] Bluetooth: hci0 urb c7304180 submission failed
[350778.217886] usb 2-2.1: new full-speed USB device number 15 using uhci_hcd
[352048.604051] usb 2-2.1: USB disconnect, device number 15
[352048.630829] Bluetooth: hci0 urb dd3d3000 submission failed
[352049.254135] usb 2-2.1: new full-speed USB device number 16 using uhci_hcd
[352111.505217] Hello, akaedu
[352111.505223] .text = e0844000
[352111.505225] .data = e0c03000
[352111.505227] .stack = df6e3f54
$ </code></pre>
<h3 id="重复插入同样的内核模块系统会报错">重复插入同样的内核模块系统会报错</h3>
<pre><code>$ sudo ./kmod-11/tools/insmod hello-module/hello.ko 
insmod: ERROR: could not insert module hello-module/hello.ko: File exists
$ lsmod | grep hello
hello                  12415  0 </code></pre>
<h2 id="thu-12-4-测试-rmmod-命令">THU-12-4 测试 rmmod 命令</h2>
<h3 id="使用测试用工具-rmmod-卸载内核模块">使用测试用工具 rmmod 卸载内核模块</h3>
<pre><code>$ sudo ./kmod-11/tools/rmmod hello-module/hello.ko
$ （rmmod 命令的执行，运行在 hello 的后面加上 .ko 的后缀，这个和以前的命令有所不同）</code></pre>
<h3 id="查看卸载内核模块后的打印结果">查看卸载内核模块后的打印结果</h3>
<pre><code>$ lsmod | grep hello
$ （可以看到上面命令的执行结果没有任何输出信息）
$ dmesg | tail
[352048.630829] Bluetooth: hci0 urb dd3d3000 submission failed
[352049.254135] usb 2-2.1: new full-speed USB device number 16 using uhci_hcd
[352111.505217] Hello, akaedu
[352111.505223] .text = e0844000
[352111.505225] .data = e0c03000
[352111.505227] .stack = df6e3f54
[352365.795618] module exit
[352365.795624] .text = e0c01000
[352365.795626] .data = e0c03000
[352365.795628] .stack = dd197f40
$ </code></pre>
<h2 id="thu-12-5-测试-lsmod-命令">THU-12-5 测试 lsmod 命令</h2>
<h3 id="lsmod-命令运行">lsmod 命令运行</h3>
<p>不加参数，直接运行 lsmod ，可以显示出当前在内核中的模块情况。</p>
<pre><code>$ ./kmod-11/tools/lsmod 
Module                  Size  Used by
nls_iso8859_1          12617  0 
nls_cp437              12751  0 
usb_storage            39646  0 
btrfs                 638208  0 
zlib_deflate           26622  1 btrfs
libcrc32c              12543  1 btrfs
ufs                    78131  0 
qnx4                   13309  0 
hfsplus                83507  0 
hfs                    49479  0 
minix                  31418  0 
ntfs                  100171  0 
vfat                   17308  0 
msdos                  17132  0 
fat                    55605  2 msdos,vfat
jfs                   175085  0 
xfs                   747494  0 
reiserfs              230896  0 
ext2                   67987  0 
usblp                  17885  0 
vmwgfx                102138  2 
ttm                    65344  1 vmwgfx
drm                   197692  3 ttm,vmwgfx
acpiphp                23535  0 
vmw_balloon            12700  0 
psmouse                72919  0 
serio_raw              13027  0 
btusb                  17912  2 
joydev                 17393  0 
rfcomm                 38139  0 
bnep                   17830  2 
bluetooth             158438  13 bnep,rfcomm,btusb
ppdev                  12849  0 
nfsd                  229850  13 
nfs                   307376  0 
lockd                  78804  2 nfs,nfsd
fscache                50642  1 nfs
i2c_piix4              13093  0 
auth_rpcgss            39597  2 nfs,nfsd
nfs_acl                12771  2 nfs,nfsd
sunrpc                205647  19 nfs_acl,auth_rpcgss,lockd,nfs,nfsd
parport_pc             32114  1 
shpchp                 32325  0 
mac_hid                13077  0 
snd_ens1371            24819  4 
gameport               15060  1 snd_ens1371
snd_rawmidi            25424  1 snd_ens1371
snd_seq_device         14172  1 snd_rawmidi
snd_ac97_codec        106082  1 snd_ens1371
ac97_bus               12642  1 snd_ac97_codec
snd_pcm                80845  3 snd_ac97_codec,snd_ens1371
snd_timer              28931  2 snd_pcm
snd                    62064  12 snd_timer,snd_pcm,snd_ac97_codec,snd_seq_device,snd_rawmidi,snd_ens1371
soundcore              14635  1 snd
snd_page_alloc         14108  1 snd_pcm
lp                     17455  0 
parport                40930  3 lp,parport_pc,ppdev
pcnet32                41110  0 
usbhid                 41906  0 
hid                    77367  1 usbhid
mptspi                 22474  2 
mptscsih               39530  1 mptspi
mptbase                96852  2 mptscsih,mptspi
floppy                 60310  0 
vmw_pvscsi             18334  0 
vmxnet3                44924  0 
$ </code></pre>
<h3 id="lsmod-命令运行参数">lsmod 命令运行参数</h3>
<p>该命令不支持带参数，因此后面如果跟某个模块名称，只会显示 usage ，不会显示模块的信息。</p>
<pre><code>$ ./kmod-11/tools/lsmod ufs
Usage: ./kmod-11/tools/lsmod
$</code></pre>
<h2 id="thu-12-6-测试-modinfo-命令">THU-12-6 测试 modinfo 命令</h2>
<h3 id="modinfo-命令运行参数">modinfo 命令运行参数</h3>
<p>对于没有依赖关系的单个 .ko 内核模块，使用 modinfo 可以直接显示出模块的信息。</p>
<pre><code>$ ./kmod-11/tools/modinfo ./hello-module/hello.ko 
filename:       ./hello-module/hello.ko
license:        GPL
description:    module example 
author:         AKAEDU
srcversion:     C928237C5C93794C5E0EF9C
depends:        
vermagic:       3.2.0-29-generic-pae SMP mod_unload modversions 686 
$ </code></pre>
<h3 id="modinfo-命令检查依赖关系">modinfo 命令检查依赖关系</h3>
<p>对于有依赖关系的单个 .ko 内核模块，使用 modinfo 可以显示出模块的依赖关系信息depends，同时也可以显示出模块加载时的参数信息parm。这个参数信息是在编译内核模块的时候，源码中通过用 MODULE_PARM_DESC() 宏来指定的。</p>
<pre><code>$ modinfo /lib/modules/3.2.0-29-generic-pae/kernel/fs/nfs/nfs.ko 
filename:       /lib/modules/3.2.0-29-generic-pae/kernel/fs/nfs/nfs.ko
license:        GPL
author:         Olaf Kirch &lt;okir@monad.swb.de&gt;
srcversion:     BB0605CB0AF0BA47415CBEC
depends:        fscache,sunrpc,lockd,auth_rpcgss,nfs_acl
intree:         Y
vermagic:       3.2.0-29-generic-pae SMP mod_unload modversions 686 
parm:           callback_tcpport:portnr
parm:           cache_getent:Path to the client cache upcall program (string)
parm:           cache_getent_timeout:Timeout (in seconds) after which the cache upcall is assumed to have failed (ulong)
parm:           enable_ino64:bool
parm:           nfs4_disable_idmapping:Turn off NFSv4 idmapping when using &#39;sec=sys&#39; (bool)
$ </code></pre>
<h3 id="查看别名信息-alias">查看别名信息 alias</h3>
<p>对于可以使用别名的内核模块，也可以用它的别名 alias 来查看模块信息。别名是在 /lib/modules/3.2.0-29-generic-pae/modules.alias 描述的模块名称的简单形式。</p>
<pre><code>$ head /lib/modules/3.2.0-29-generic-pae/modules.alias
# Aliases extracted from modules themselves.
alias pci:v00008086d00003422sv*sd*bc*sc*i* mce_xeon75xx
alias char-major-10-134 apm
alias devname:cpu/microcode microcode
alias char-major-10-184 microcode
alias aes-asm aes_i586
alias aes aes_i586
alias twofish-asm twofish_i586
alias twofish twofish_i586
alias salsa20-asm salsa20_i586</code></pre>
<p>但是在这个文件中，别名为 aes 的模块，还有很多个，通过 grep &quot;alias aes&quot; 可以看出一共有3个别名都是 aes 的模块，分别是 aes_i586, aesni_intel, padlock_aes。</p>
<pre><code>$ cat /lib/modules/3.2.0-29-generic-pae/modules.alias | grep &quot;alias aes&quot;
alias aes-asm aes_i586
alias aes aes_i586
alias aes aesni_intel
alias aes padlock_aes</code></pre>
<h3 id="使用-modinfo-查看各个依赖模块信息">使用 modinfo 查看各个依赖模块信息</h3>
<p>通过 modinfo 来查看 aes 这个别名所对应的模块信息，可以看到这3个模块所对应的模块文件 crypto/aes-i586.ko，aesni-intel.ko，padlock-aes.ko 的详细信息。</p>
<pre><code>$ ./kmod-11/tools/modinfo aes 
filename:       /lib/modules/3.2.0-29-generic-pae/kernel/arch/x86/crypto/aes-i586.ko
alias:          aes-asm
alias:          aes
license:        GPL
description:    Rijndael (AES) Cipher Algorithm, asm optimized
srcversion:     24373C7FF739526E8AAF1B0
depends:        
intree:         Y
vermagic:       3.2.0-29-generic-pae SMP mod_unload modversions 686 

filename:       /lib/modules/3.2.0-29-generic-pae/kernel/arch/x86/crypto/aesni-intel.ko
alias:          aes
license:        GPL
description:    Rijndael (AES) Cipher Algorithm, Intel AES-NI instructions optimized
srcversion:     E0B859CB1FF480D0B70F6F2
depends:        cryptd,aes-i586
intree:         Y
vermagic:       3.2.0-29-generic-pae SMP mod_unload modversions 686 

filename:       /lib/modules/3.2.0-29-generic-pae/kernel/drivers/crypto/padlock-aes.ko
alias:          aes
author:         Michal Ludvig
license:        GPL
description:    VIA PadLock AES algorithm support
srcversion:     6842B20FF8E68314ED45103
depends:        
intree:         Y
vermagic:       3.2.0-29-generic-pae SMP mod_unload modversions 686 
$ </code></pre>
<h2 id="thu-12-7-测试-depmod-命令">THU-12-7 测试 depmod 命令</h2>
<h3 id="直接运行-depmod-命令">直接运行 depmod 命令</h3>
<pre><code>$ ./kmod-11/tools/depmod </code></pre>
<h3 id="查看生成的-modules.dep-文件">查看生成的 modules.dep 文件</h3>
<pre><code>$ cat /lib/modules/3.2.0-29-generic-pae/modules.dep
$ cat /lib/modules/3.2.0-29-generic-pae/modules.dep | head
kernel/arch/x86/kernel/cpu/mcheck/mce-xeon75xx.ko:
kernel/arch/x86/kernel/cpu/mcheck/mce-inject.ko:
kernel/arch/x86/kernel/msr.ko:
kernel/arch/x86/kernel/cpuid.ko:
kernel/arch/x86/kernel/apm.ko:
kernel/arch/x86/kernel/microcode.ko:
kernel/arch/x86/crypto/aes-i586.ko:
kernel/arch/x86/crypto/twofish-i586.ko: kernel/crypto/twofish_common.ko
kernel/arch/x86/crypto/salsa20-i586.ko:
kernel/arch/x86/crypto/aesni-intel.ko: kernel/arch/x86/crypto/aes-i586.ko kernel/crypto/cryptd.ko
$ </code></pre>
<h2 id="thu-12-8-测试-modprobe-命令">THU-12-8 测试 modprobe 命令</h2>
<h3 id="直接运行-modprobe-命令加--l-参数查看可以加载的模块">直接运行 modprobe 命令，加 -l 参数查看可以加载的模块</h3>
<pre><code>$ sudo ./kmod-11/tools/modprobe -l | grep nfs
kernel/fs/nfs_common/nfs_acl.ko
kernel/fs/nfs/nfs.ko
kernel/fs/nfsd/nfsd.ko
kernel/drivers/xen/xenfs/xenfs.ko
$ </code></pre>
<h3 id="直接运行-modprobe-命令加--d-参数查看依赖关系">直接运行 modprobe 命令，加 -D 参数查看依赖关系</h3>
<pre><code>$ sudo ./kmod-11/tools/modprobe -D nfs
insmod /lib/modules/3.2.0-29-generic-pae/kernel/net/sunrpc/sunrpc.ko 
insmod /lib/modules/3.2.0-29-generic-pae/kernel/fs/lockd/lockd.ko 
insmod /lib/modules/3.2.0-29-generic-pae/kernel/fs/fscache/fscache.ko 
insmod /lib/modules/3.2.0-29-generic-pae/kernel/net/sunrpc/auth_gss/auth_rpcgss.ko 
insmod /lib/modules/3.2.0-29-generic-pae/kernel/fs/nfs_common/nfs_acl.ko 
insmod /lib/modules/3.2.0-29-generic-pae/kernel/fs/nfs/nfs.ko </code></pre>
<h3 id="使用-modprobe-nfs-加载-nfs-内核模块和相关依赖模块">使用 modprobe nfs 加载 nfs 内核模块和相关依赖模块</h3>
<pre><code>$ sudo ./kmod-11/tools/modprobe nfs
$ lsmod | grep nfs
nfsd                  229850  13 
nfs                   307376  0 
nfs_acl                12771  2 nfsd,nfs
auth_rpcgss            39597  2 nfsd,nfs
fscache                50642  1 nfs
lockd                  78804  2 nfsd,nfs
sunrpc                205647  19 nfsd,nfs,nfs_acl,auth_rpcgss,lockd
$ </code></pre>
<h3 id="使用-modprobe--r-nfs-卸载-nfs-内核模块和相关依赖模块">使用 modprobe -r nfs 卸载 nfs 内核模块和相关依赖模块</h3>
<pre><code>$ sudo ./kmod-11/tools/modprobe -r  nfs
[sudo] password for akaedu: 

$ lsmod | grep nfs
nfsd                  229850  13 
nfs_acl                12771  1 nfsd
auth_rpcgss            39597  1 nfsd
lockd                  78804  1 nfsd
sunrpc                205647  18 nfsd,nfs_acl,auth_rpcgss,lockd
$ </code></pre>
<h2 id="thu-12-9-测试-modprobe-命令参数">THU-12-9 测试 modprobe 命令参数</h2>
<h3 id="查看依赖关系-show-depends">查看依赖关系 show-depends</h3>
<pre><code>$ modprobe --show-depends module_name</code></pre>
<p>查看 nfs 模块的依赖关系，也就是依赖于哪些模块的加载</p>
<pre><code>$ modprobe --show-depends nfs
insmod /lib/modules/3.2.0-29-generic-pae/kernel/net/sunrpc/sunrpc.ko 
insmod /lib/modules/3.2.0-29-generic-pae/kernel/fs/lockd/lockd.ko 
insmod /lib/modules/3.2.0-29-generic-pae/kernel/fs/fscache/fscache.ko 
insmod /lib/modules/3.2.0-29-generic-pae/kernel/net/sunrpc/auth_gss/auth_rpcgss.ko 
insmod /lib/modules/3.2.0-29-generic-pae/kernel/fs/nfs_common/nfs_acl.ko 
insmod /lib/modules/3.2.0-29-generic-pae/kernel/fs/nfs/nfs.ko 
$ </code></pre>
<h3 id="查看配置信息-config">查看配置信息 config</h3>
<p>查看以 nfs 结尾的符号信息，也就是 nfs 模块所 export 的符号表</p>
<pre><code>$ modprobe -c | egrep &quot;nfs$&quot;
alias symbol:nfs4_reset_read nfs
alias symbol:nfs4_reset_write nfs
alias symbol:nfs4_set_ds_client nfs
alias symbol:nfs_commit_clear_lock nfs
alias symbol:nfs_commit_free nfs
alias symbol:nfs_commit_release_pages nfs
alias symbol:nfs_commitdata_alloc nfs
alias symbol:nfs_commitdata_release nfs
alias symbol:nfs_generic_pg_test nfs
alias symbol:nfs_init_commit nfs
alias symbol:nfs_initiate_commit nfs
alias symbol:nfs_initiate_read nfs
alias symbol:nfs_initiate_write nfs
alias symbol:nfs_pageio_reset_read_mds nfs
alias symbol:nfs_pageio_reset_write_mds nfs
alias symbol:nfs_put_client nfs
alias symbol:nfs_retry_commit nfs
$ </code></pre>
<h3 id="查看模块内部信息-show-modversions">查看模块内部信息 show-modversions</h3>
<pre><code>$ ../kmod-11/tools/modprobe  --show-modversions ../hello-module/hello.ko 
program_invocation_short_name = modprobe
program_invocation_name = ../kmod-11/tools/modprobe
program_invocation_short_name = bfeb3601
0x75646f6d98397cc5  le_layout
0x6666696a7d11c268  ies
0x6e69727050eedeb8  tk

$ ../kmod-11/tools/modprobe  --show-modversions ../kmod-11/testsuite/rootfs-pristine/test-init/ext4-i686.ko 
program_invocation_short_name = modprobe
program_invocation_name = ../kmod-11/tools/modprobe
program_invocation_short_name = bfc845de
0x75646f6d0041086e  le_layout
0x635f626dcefcf88c  ache_entry_find_next
0x6a626f6b9bedef39  ect_put
0x646b6c62d42788de  ev_issue_discard
0x7465736b5edae721  _create_and_add
0x61705f6444cd091f  th</code></pre>
<h2 id="thu-12-10-修改调试-depmod-命令">THU-12-10 修改调试 depmod 命令</h2>
<h3 id="修改源码插入打印函数">修改源码，插入打印函数</h3>
<pre><code>$ vi ./kmod-11/tools/depmod.c
修改源码文件，在 output_deps 函数中间插入打印函数，打印输出到标准输出 stdout。

1790 static int output_deps(struct depmod *depmod, FILE *out)
1791 {
1792         size_t i;
1793 
1794         fprintf(stdout, &quot;total count %d&quot;, depmod-&gt;modules.count);
1795 ...
1798                 const char *p = mod_get_compressed_path(mod);
1799                 size_t j, n_deps;
1800 
1801                 if (mod-&gt;dep_loop) {
1802                         DBG(&quot;Ignored %s due dependency loops\n&quot;, p);
1803                         continue;
1804                 }
1805 
1806                 fprintf(out, &quot;%s:&quot;, p);
1807                 fprintf(stdout, &quot;%s:&quot;, p);</code></pre>
<h3 id="重新编译生成新的-depmod">重新编译生成新的 depmod</h3>
<pre><code>$ make -C kmod-11
make[1]: Entering directory `/home/akaedu/Github/comment-subs/kmod-11&#39;
make --no-print-directory all-recursive
Making all in .
  CC       tools/depmod.o
  CCLD     tools/kmod
  CCLD     tools/kmod-nolib
Making all in libkmod/docs
make[3]: Nothing to be done for `all&#39;.
Making all in man
make[3]: Nothing to be done for `all&#39;.
make[1]: Leaving directory `/home/akaedu/Github/comment-subs/kmod-11&#39;</code></pre>
<h3 id="再次执行-depmod观察从标准输出的打印信息">再次执行 depmod，观察从标准输出的打印信息</h3>
<pre><code>$ sudo ./kmod-11/tools/depmod | head
total count 3529
kernel/arch/x86/kernel/cpu/mcheck/mce-xeon75xx.ko:
kernel/arch/x86/kernel/cpu/mcheck/mce-inject.ko:
kernel/arch/x86/kernel/msr.ko:
kernel/arch/x86/kernel/cpuid.ko:
kernel/arch/x86/kernel/apm.ko:
kernel/arch/x86/kernel/microcode.ko:
kernel/arch/x86/crypto/aes-i586.ko:
kernel/arch/x86/crypto/twofish-i586.ko: kernel/crypto/twofish_common.ko
kernel/arch/x86/crypto/salsa20-i586.ko:
kernel/arch/x86/crypto/aesni-intel.ko: kernel/arch/x86/crypto/aes-i586.ko kernel/crypto/cryptd.ko
$ </code></pre>
<h2 id="thu-12-11-修改调试-modprobe-命令">THU-12-11 修改调试 modprobe 命令</h2>
<h3 id="查看-modprobe-源码">查看 modprobe 源码</h3>
<pre><code>$ vi kmod-11/tools/modprobe.c 
跟踪 modprobe 函数执行过程，最后在 libkmod-module.c 中找到构建模块依赖关系的代码

$ vi kmod-11/libkmod/libkmod-module.c +600
600 static const struct kmod_list *module_get_dependencies_noref(const struct kmod_module *mod)
601 {
602         if (!mod-&gt;init.dep) {
603                 /* lazy init */
604                 char *line = kmod_search_moddep(mod-&gt;ctx, mod-&gt;name);
605 
606                 if (line == NULL)
607                         return NULL;
608 
609                 kmod_module_parse_depline((struct kmod_module *)mod, line);
610                 free(line);
611 
612                 if (!mod-&gt;init.dep)
613                         return NULL;
614         }
615 
616         return mod-&gt;dep;
617 }</code></pre>
<h3 id="修改-kmod_module_parse_depline-函数">修改 kmod_module_parse_depline 函数</h3>
<pre><code>$ vi kmod-11/libkmod/libkmod-module.c +120
120 int kmod_module_parse_depline(struct kmod_module *mod, char *line)
121 {
122         struct kmod_ctx *ctx = mod-&gt;ctx;
123         struct kmod_list *list = NULL;
124         const char *dirname;
125         char buf[PATH_MAX];
126         char *p, *saveptr;
127         int err = 0, n = 0;
128         size_t dirnamelen;
129 
130         printf(&quot;&lt;mydebug&gt; line = %s\n&quot;, line);
131 
132         if (mod-&gt;init.dep)
133                 return mod-&gt;n_dep;
134         assert(mod-&gt;dep == NULL);
135         mod-&gt;init.dep = true;
136 
137         p = strchr(line, &#39;:&#39;);
138         if (p == NULL)
139                 return 0;
140 </code></pre>
<h3 id="插入130行的打印-line-的语句">插入130行的打印 line 的语句</h3>
<pre><code>130         printf(&quot;&lt;mydebug&gt; line = %s\n&quot;, line);</code></pre>
<h3 id="重新编译生成新的-modprobe">重新编译生成新的 modprobe</h3>
<pre><code>$ make -C kmod-11/
make: Entering directory `/home/akaedu/Github/test-kmod-11/kmod-11&#39;
make --no-print-directory all-recursive
Making all in .
  CC       libkmod/libkmod-module.lo
  CCLD     libkmod/libkmod.la
  CCLD     libkmod/libkmod-private.la
  CCLD     tools/kmod
  CCLD     tools/kmod-nolib
Making all in libkmod/docs
make[2]: Nothing to be done for `all&#39;.
Making all in man
make[2]: Nothing to be done for `all&#39;.
make: Leaving directory `/home/akaedu/Github/test-kmod-11/kmod-11&#39;
$ </code></pre>
<h3 id="运行-modprobe-nfs">运行 modprobe nfs</h3>
<pre><code>$ ./kmod-11/tools/modprobe nfs
&lt;mydebug&gt; line = kernel/fs/nfs/nfs.ko: kernel/fs/nfs_common/nfs_acl.ko kernel/net/sunrpc/auth_gss/auth_rpcgss.ko kernel/fs/fscache/fscache.ko kernel/fs/lockd/lockd.ko kernel/net/sunrpc/sunrpc.ko
$ </code></pre>
<h3 id="插入167行打印语句">插入167行打印语句</h3>
<pre><code>$ vi kmod-11/libkmod/libkmod-module.c +161
161         p++;
162         for (p = strtok_r(p, &quot; \t&quot;, &amp;saveptr); p != NULL;
163                                         p = strtok_r(NULL, &quot; \t&quot;, &amp;saveptr)     ) {
164                 struct kmod_module *depmod;
165                 const char *path;
166 
167                 printf(&quot;&lt;mydebug&gt; p = %s\n&quot;, p);
168                 path = path_join(p, dirnamelen, buf);
169                 if (path == NULL) {
170                         ERR(ctx, &quot;could not join path &#39;%s&#39; and &#39;%s&#39;.\n&quot;,
171                             dirname, p);
172                         goto fail;
173                 }</code></pre>
<h3 id="重新编译生成新的-modprobe-1">重新编译生成新的 modprobe</h3>
<pre><code>$ make -C kmod-11/
make: Entering directory `/home/akaedu/Github/test-kmod-11/kmod-11&#39;
make --no-print-directory all-recursive
Making all in .
  CC       libkmod/libkmod-module.lo
  CCLD     libkmod/libkmod.la
  CCLD     libkmod/libkmod-private.la
  CCLD     tools/kmod
  CCLD     tools/kmod-nolib
Making all in libkmod/docs
make[2]: Nothing to be done for `all&#39;.
Making all in man
make[2]: Nothing to be done for `all&#39;.
make: Leaving directory `/home/akaedu/Github/test-kmod-11/kmod-11&#39;
$ </code></pre>
<h3 id="运行-modprobe-nfs-1">运行 modprobe nfs</h3>
<pre><code>$ ./kmod-11/tools/modprobe nfs
&lt;mydebug&gt; line = kernel/fs/nfs/nfs.ko: kernel/fs/nfs_common/nfs_acl.ko kernel/net/sunrpc/auth_gss/auth_rpcgss.ko kernel/fs/fscache/fscache.ko kernel/fs/lockd/lockd.ko kernel/net/sunrpc/sunrpc.ko
&lt;mydebug&gt; p = kernel/fs/nfs_common/nfs_acl.ko
&lt;mydebug&gt; p = kernel/net/sunrpc/auth_gss/auth_rpcgss.ko
&lt;mydebug&gt; p = kernel/fs/fscache/fscache.ko
&lt;mydebug&gt; p = kernel/fs/lockd/lockd.ko
&lt;mydebug&gt; p = kernel/net/sunrpc/sunrpc.ko</code></pre>
<h2 id="thu-12-12-编译生成-testsuite-命令集">THU-12-12 编译生成 testsuite 命令集</h2>
<h3 id="make-check-编译并运行集成测试">make check 编译并运行集成测试</h3>
<pre><code>$ make check
Making check in .
  GEN      rootfs
make --no-print-directory testsuite/uname.la testsuite/path.la testsuite/init_module.la testsuite/delete_module.la testsuite/libtestsuite.la testsuite/test-init testsuite/test-testsuite testsuite/test-loaded testsuite/test-modinfo testsuite/test-alias testsuite/test-new-module testsuite/test-modprobe testsuite/test-blacklist testsuite/test-dependencies testsuite/test-depmod
  CC       testsuite/uname.lo
  CCLD     testsuite/uname.la
  CC       testsuite/path.lo
  CCLD     testsuite/path.la
  CC       testsuite/init_module.lo
  CC       testsuite/mkdir.lo
  CCLD     testsuite/init_module.la
  CC       testsuite/delete_module.lo
  CCLD     testsuite/delete_module.la
  CC       testsuite/testsuite_libtestsuite_la-testsuite.lo
  CCLD     testsuite/libtestsuite.la
  CC       testsuite/testsuite_test_init-test-init.o
  CCLD     testsuite/test-init
  CC       testsuite/testsuite_test_testsuite-test-testsuite.o
  CCLD     testsuite/test-testsuite
  CC       testsuite/testsuite_test_loaded-test-loaded.o
  CCLD     testsuite/test-loaded
  CC       testsuite/testsuite_test_modinfo-test-modinfo.o
  CCLD     testsuite/test-modinfo
  CC       testsuite/testsuite_test_alias-test-alias.o
  CCLD     testsuite/test-alias
  CC       testsuite/testsuite_test_new_module-test-new-module.o
  CCLD     testsuite/test-new-module
  CC       testsuite/testsuite_test_modprobe-test-modprobe.o
  CCLD     testsuite/test-modprobe
  CC       testsuite/testsuite_test_blacklist-test-blacklist.o
  CCLD     testsuite/test-blacklist
  CC       testsuite/testsuite_test_dependencies-test-dependencies.o
  CCLD     testsuite/test-dependencies
  CC       testsuite/testsuite_test_depmod-test-depmod.o
  CCLD     testsuite/test-depmod
make --no-print-directory check-TESTS
TESTSUITE: running test_initlib, in forked context
TESTSUITE: &#39;test_initlib&#39; [20196] exited with return code 0
TESTSUITE: PASSED: test_initlib
TESTSUITE: running test_insert, in forked context
TESTSUITE: &#39;test_insert&#39; [20197] exited with return code 0
TESTSUITE: PASSED: test_insert
TESTSUITE: running test_remove, in forked context
TESTSUITE: &#39;test_remove&#39; [20198] exited with return code 0
TESTSUITE: PASSED: test_remove
PASS: testsuite/test-init
TESTSUITE: running testsuite_uname, in forked context
TRAP uname(): missing export TESTSUITE_UNAME_R?
TESTSUITE: &#39;testsuite_uname&#39; [20202] exited with return code 0
TESTSUITE: PASSED: testsuite_uname
TESTSUITE: running testsuite_rootfs_fopen, in forked context
TESTSUITE: &#39;testsuite_rootfs_fopen&#39; [20203] exited with return code 0
TESTSUITE: PASSED: testsuite_rootfs_fopen
TESTSUITE: running testsuite_rootfs_open, in forked context
TESTSUITE: &#39;testsuite_rootfs_open&#39; [20204] exited with return code 0
TESTSUITE: PASSED: testsuite_rootfs_open
TESTSUITE: running testsuite_rootfs_stat_access, in forked context
TESTSUITE: &#39;testsuite_rootfs_stat_access&#39; [20205] exited with return code 0
TESTSUITE: PASSED: testsuite_rootfs_stat_access
TESTSUITE: running testsuite_rootfs_opendir, in forked context
TESTSUITE: &#39;testsuite_rootfs_opendir&#39; [20206] exited with return code 0
TESTSUITE: PASSED: testsuite_rootfs_opendir
PASS: testsuite/test-testsuite
TESTSUITE: running loaded_1, in forked context
TESTSUITE: &#39;loaded_1&#39; [20210] exited with return code 0
TESTSUITE: PASSED: loaded_1
PASS: testsuite/test-loaded
TESTSUITE: running modinfo_jonsmodules, in forked context
TESTSUITE: &#39;modinfo_jonsmodules&#39; [20214] exited with return code 0
TESTSUITE: PASSED: modinfo_jonsmodules
PASS: testsuite/test-modinfo
TESTSUITE: running alias_1, in forked context
TESTSUITE: &#39;alias_1&#39; [20218] exited with return code 0
TESTSUITE: PASSED: alias_1
PASS: testsuite/test-alias
TESTSUITE: running from_name, in forked context
TESTSUITE: &#39;from_name&#39; [20222] exited with return code 0
TESTSUITE: PASSED: from_name
TESTSUITE: running from_alias, in forked context
TESTSUITE: &#39;from_alias&#39; [20223] exited with return code 0
TESTSUITE: PASSED: from_alias
PASS: testsuite/test-new-module
TESTSUITE: running modprobe_show_depends, in forked context
TESTSUITE: &#39;modprobe_show_depends&#39; [20227] exited with return code 0
TESTSUITE: PASSED: modprobe_show_depends
TESTSUITE: running modprobe_show_depends2, in forked context
TESTSUITE: &#39;modprobe_show_depends2&#39; [20228] exited with return code 0
TESTSUITE: PASSED: modprobe_show_depends2
TESTSUITE: running modprobe_builtin, in forked context
TESTSUITE: &#39;modprobe_builtin&#39; [20229] exited with return code 0
TESTSUITE: PASSED: modprobe_builtin
TESTSUITE: running modprobe_softdep_loop, in forked context
TESTSUITE: &#39;modprobe_softdep_loop&#39; [20230] exited with return code 0
TESTSUITE: PASSED: modprobe_softdep_loop
TESTSUITE: running modprobe_install_cmd_loop, in forked context
TESTSUITE: ERR: Test &#39;modprobe_install_cmd_loop&#39; timed out, killing 20231
TESTSUITE: ERR: &#39;modprobe_install_cmd_loop&#39; [20231] terminated by signal 9 (Killed)
FAIL: testsuite/test-modprobe
TESTSUITE: running blacklist_1, in forked context
TESTSUITE: &#39;blacklist_1&#39; [20283] exited with return code 0
TESTSUITE: PASSED: blacklist_1
PASS: testsuite/test-blacklist
TESTSUITE: running test_dependencies, in forked context
TRAP uname(): missing export TESTSUITE_UNAME_R?
TESTSUITE: &#39;test_dependencies&#39; [20287] exited with return code 0
TESTSUITE: PASSED: test_dependencies
PASS: testsuite/test-dependencies
TESTSUITE: running depmod_modules_order_for_compressed, in forked context
TESTSUITE: &#39;depmod_modules_order_for_compressed&#39; [20291] exited with return code 0
TESTSUITE: ERR: sizes do not match /home/akaedu/Github/test-kmod-11/kmod-11/testsuite/rootfs/test-depmod/modules-order-compressed/lib/modules/3.5.4-1-ARCH/correct-modules.alias /home/akaedu/Github/test-kmod-11/kmod-11/testsuite/rootfs/test-depmod/modules-order-compressed/lib/modules/3.5.4-1-ARCH/modules.alias
TESTSUITE: ERR: FAILED: exit ok but outputs do not match: depmod_modules_order_for_compressed
FAIL: testsuite/test-depmod
==============================================
2 of 10 tests failed
Please report to linux-modules@vger.kernel.org
==============================================
make[2]: *** [check-TESTS] Error 1
make[1]: *** [check-am] Error 2
make: *** [check-recursive] Error 1
$ Killed

$ </code></pre>
<h3 id="单独创建根文件系统">单独创建根文件系统</h3>
<pre><code>$ sudo make rootfs
[sudo] password for akaedu: 
akaeduSorry, try again.
[sudo] password for akaedu: 
  GEN      rootfs</code></pre>
<h3 id="查看生成的-rootfs">查看生成的 rootfs</h3>
<pre><code>$ ls testsuite/rootfs
test-alias         test-depmod  test-modinfo     test-remove
test-blacklist     test-init    test-modprobe    test-rootfs
test-dependencies  test-loaded  test-new-module
$ </code></pre>
<h3 id="确认没有此时-rootfstest-init-下没有生成-sys-子目录">确认没有此时 rootfs/test-init/ 下没有生成 sys 子目录</h3>
<pre><code>$ cat testsuite/rootfs/test-init/
correct.txt     ext4-ppc64.ko   ext4-x86_64.ko  
ext4-i686.ko    ext4-s390x.ko   </code></pre>
<h3 id="运行-test-init-命令">运行 test-init 命令</h3>
<pre><code>$ sudo ./testsuite/test-init 
TESTSUITE: running test_initlib, in forked context
TESTSUITE: &#39;test_initlib&#39; [32704] exited with return code 0
TESTSUITE: PASSED: test_initlib
TESTSUITE: running test_insert, in forked context
TESTSUITE: &#39;test_insert&#39; [32705] exited with return code 0
TESTSUITE: PASSED: test_insert
TESTSUITE: running test_remove, in forked context
TESTSUITE: &#39;test_remove&#39; [32706] exited with return code 0
TESTSUITE: PASSED: test_remove</code></pre>
<h3 id="查看-rootfstest-init-已经产生-sys-子目录">查看 rootfs/test-init/ 已经产生 sys 子目录</h3>
<pre><code>$ cat testsuite/rootfs/test-init/
correct.txt     ext4-ppc64.ko   ext4-x86_64.ko
ext4-i686.ko    ext4-s390x.ko   sys/</code></pre>
<h3 id="查看-initstate-文件的内容为-live-字符串">查看 initstate 文件的内容为 &quot;live&quot; 字符串</h3>
<pre><code>$ cat testsuite/rootfs/test-init/sys/module/ext4/initstate 
live
$ </code></pre>
<h2 id="thu-12-13-编译生成-debug-版">THU-12-13 编译生成 Debug 版</h2>
<h3 id="配置时加上---enable-debug---enable-logging-参数">配置时加上 --enable-debug, --enable-logging 参数</h3>
<pre><code>$ ./configure CFLAGS=&quot;-g -O2&quot; --prefix=/usr --sysconfdir=/etc --libdir=/usr/lib --enable-debug --enable-logging
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for a thread-safe mkdir -p... /bin/mkdir -p
checking for gawk... no
checking for mawk... mawk
checking whether make sets $(MAKE)... yes
checking whether make supports nested variables... yes
checking how to create a pax tar archive... gnutar
checking for style of include used by make... GNU
checking for gcc... gcc
checking whether the C compiler works... yes
checking for C compiler default output file name... a.out
checking for suffix of executables... 
checking whether we are cross compiling... no
checking for suffix of object files... o
checking whether we are using the GNU C compiler... yes
checking whether gcc accepts -g... yes
checking for gcc option to accept ISO C89... none needed
checking dependency style of gcc... gcc3
checking for gcc option to accept ISO C99... -std=gnu99
checking for gcc -std=gnu99 option to accept ISO Standard C... (cached) -std=gnu99
checking how to run the C preprocessor... gcc -std=gnu99 -E
checking for grep that handles long lines and -e... /bin/grep
checking for egrep... /bin/grep -E
checking for ANSI C header files... yes
checking for sys/types.h... yes
checking for sys/stat.h... yes
checking for stdlib.h... yes
checking for string.h... yes
checking for memory.h... yes
checking for strings.h... yes
checking for inttypes.h... yes
checking for stdint.h... yes
checking for unistd.h... yes
checking minix/config.h usability... no
checking minix/config.h presence... no
checking for minix/config.h... no
checking whether it is safe to define __EXTENSIONS__... yes
checking for special C compiler options needed for large files... no
checking for _FILE_OFFSET_BITS value needed for large files... 64
checking whether make supports nested variables... (cached) yes
checking build system type... i686-pc-linux-gnu
checking host system type... i686-pc-linux-gnu
checking how to print strings... printf
checking for a sed that does not truncate output... /bin/sed
checking for fgrep... /bin/grep -F
checking for ld used by gcc -std=gnu99... /usr/bin/ld
checking if the linker (/usr/bin/ld) is GNU ld... yes
checking for BSD- or MS-compatible name lister (nm)... /usr/bin/nm -B
checking the name lister (/usr/bin/nm -B) interface... BSD nm
checking whether ln -s works... yes
checking the maximum length of command line arguments... 1572864
checking whether the shell understands some XSI constructs... yes
checking whether the shell understands &quot;+=&quot;... yes
checking how to convert i686-pc-linux-gnu file names to i686-pc-linux-gnu format... func_convert_file_noop
checking how to convert i686-pc-linux-gnu file names to toolchain format... func_convert_file_noop
checking for /usr/bin/ld option to reload object files... -r
checking for objdump... objdump
checking how to recognize dependent libraries... pass_all
checking for dlltool... no
checking how to associate runtime and link libraries... printf %s\n
checking for ar... ar
checking for archiver @FILE support... @
checking for strip... strip
checking for ranlib... ranlib
checking command to parse /usr/bin/nm -B output from gcc -std=gnu99 object... ok
checking for sysroot... no
checking for mt... mt
checking if mt is a manifest tool... no
checking for dlfcn.h... yes
checking for objdir... .libs
checking if gcc -std=gnu99 supports -fno-rtti -fno-exceptions... no
checking for gcc -std=gnu99 option to produce PIC... -fPIC -DPIC
checking if gcc -std=gnu99 PIC flag -fPIC -DPIC works... yes
checking if gcc -std=gnu99 static flag -static works... yes
checking if gcc -std=gnu99 supports -c -o file.o... yes
checking if gcc -std=gnu99 supports -c -o file.o... (cached) yes
checking whether the gcc -std=gnu99 linker (/usr/bin/ld) supports shared libraries... yes
checking whether -lc should be explicitly linked in... no
checking dynamic linker characteristics... GNU/Linux ld.so
checking how to hardcode library paths into programs... immediate
checking whether stripping libraries is possible... yes
checking if libtool supports shared libraries... yes
checking whether to build shared libraries... yes
checking whether to build static libraries... no
checking for gcc... (cached) gcc
checking whether we are using the GNU C compiler... (cached) yes
checking whether gcc accepts -g... (cached) yes
checking for gcc option to accept ISO C89... (cached) none needed
checking dependency style of gcc... (cached) gcc3
checking for gcc option to accept ISO C99... (cached) -std=gnu99
checking for typeof syntax and keyword spelling... typeof
checking whether gcc -std=gnu99 and cc understand -c and -o together... yes
checking whether gcc -std=gnu99 needs -traditional... no
checking whether byte ordering is bigendian... no
checking for a sed that does not truncate output... (cached) /bin/sed
checking for pkg-config... /usr/bin/pkg-config
checking pkg-config is at least version 0.9.0... yes
checking for __xstat... yes
checking for struct stat.st_mtim... yes
configure: Xz support not requested
configure: zlib support not requested
checking for xsltproc... /usr/bin/xsltproc
checking for gtkdoc-check... no
checking for gtkdoc-rebase... no
checking for gtkdoc-mkpdf... no
checking whether to build gtk-doc documentation... no
checking if gcc -std=gnu99 supports flag -pipe in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -DANOTHER_BRICK_IN_THE in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wall in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -W in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wextra in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wno-inline in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wvla in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wundef in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wformat=2 in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wlogical-op in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wsign-compare in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wformat-security in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wmissing-include-dirs in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wformat-nonliteral in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wold-style-definition in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wpointer-arith in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Winit-self in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wdeclaration-after-statement in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wfloat-equal in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wmissing-prototypes in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wstrict-prototypes in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wredundant-decls in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wmissing-declarations in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wmissing-noreturn in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wshadow in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wendif-labels in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wstrict-aliasing=2 in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wwrite-strings in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wno-long-long in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wno-overlength-strings in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wno-unused-parameter in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wno-missing-field-initializers in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wno-unused-result in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wnested-externs in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wchar-subscripts in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wtype-limits in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wuninitialized in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -fno-common in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -fdiagnostics-show-option in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -fvisibility=hidden in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -ffunction-sections in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -fdata-sections in envvar CFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wl,--as-needed in envvar LDFLAGS... yes
checking if gcc -std=gnu99 supports flag -Wl,--gc-sections in envvar LDFLAGS... yes
checking that generated files are newer than configure... done
configure: creating ./config.status
config.status: creating Makefile
config.status: creating man/Makefile
config.status: creating libkmod/docs/Makefile
config.status: creating libkmod/docs/version.xml
config.status: creating config.h
config.status: executing depfiles commands

config.status: executing libtool commands

    kmod 11
    ======

    prefix:         /usr
    sysconfdir:     /etc
    libdir:         /usr/lib
    rootlibdir:     /usr/lib
    includedir:     ${prefix}/include
    bindir:         ${exec_prefix}/bin

    compiler:       gcc -std=gnu99
    cflags:          -pipe -DANOTHER_BRICK_IN_THE -Wall -W -Wextra -Wno-inline -Wvla -Wundef -Wformat=2 -Wlogical-op -Wsign-compare -Wformat-security -Wmissing-include-dirs -Wformat-nonliteral -Wold-style-definition -Wpointer-arith -Winit-self -Wdeclaration-after-statement -Wfloat-equal -Wmissing-prototypes -Wstrict-prototypes -Wredundant-decls -Wmissing-declarations -Wmissing-noreturn -Wshadow -Wendif-labels -Wstrict-aliasing=2 -Wwrite-strings -Wno-long-long -Wno-overlength-strings -Wno-unused-parameter -Wno-missing-field-initializers -Wno-unused-result -Wnested-externs -Wchar-subscripts -Wtype-limits -Wuninitialized -fno-common -fdiagnostics-show-option -fvisibility=hidden -ffunction-sections -fdata-sections -g -O2
    ldflags:         -Wl,--as-needed -Wl,--gc-sections 

    tools:          yes
    logging:        yes
    compression:        xz=no  zlib=no
    debug:          yes
    doc:            no
    man:            yes</code></pre>
<h3 id="make-clean-make-重新编译">make clean &amp;&amp; make 重新编译</h3>
<pre><code>$ make clean &amp;&amp; make</code></pre>
<h3 id="设置日志优先级-kmod_log7">设置日志优先级 KMOD_LOG=7</h3>
<pre><code>$ export KMOD_LOG=7</code></pre>
<h3 id="重新运行-lsmod-命令观察调试信息输出">重新运行 lsmod 命令，观察调试信息输出</h3>
<pre><code>$ ./tools/lsmod 
libkmod: INFO libkmod/libkmod.c:275 kmod_new: ctx 0x9c4f008 created
libkmod: DEBUG libkmod/libkmod.c:276 kmod_new: log_priority=7
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;vmwgfx&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c4f088 key=&#39;vmwgfx&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;ttm&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c4fec8 key=&#39;ttm&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;drm&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c4ff60 key=&#39;drm&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;acpiphp&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c4fff8 key=&#39;acpiphp&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;vmw_balloon&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50090 key=&#39;vmw_balloon&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;psmouse&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50130 key=&#39;psmouse&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;serio_raw&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c501c8 key=&#39;serio_raw&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;joydev&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50268 key=&#39;joydev&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;btusb&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50300 key=&#39;btusb&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;nfsd&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50398 key=&#39;nfsd&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;i2c_piix4&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50430 key=&#39;i2c_piix4&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;bnep&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c504d0 key=&#39;bnep&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;shpchp&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50568 key=&#39;shpchp&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;rfcomm&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50600 key=&#39;rfcomm&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;nfs&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50698 key=&#39;nfs&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;bluetooth&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50730 key=&#39;bluetooth&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;mac_hid&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c507d0 key=&#39;mac_hid&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;parport_pc&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50868 key=&#39;parport_pc&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;ppdev&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50908 key=&#39;ppdev&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;nfs_acl&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c509a0 key=&#39;nfs_acl&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;auth_rpcgss&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50a38 key=&#39;auth_rpcgss&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;fscache&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50ad8 key=&#39;fscache&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;lockd&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50b70 key=&#39;lockd&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;sunrpc&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50c08 key=&#39;sunrpc&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_ens1371&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50ca0 key=&#39;snd_ens1371&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_ac97_codec&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50d40 key=&#39;snd_ac97_codec&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;ac97_bus&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50de0 key=&#39;ac97_bus&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;gameport&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50e80 key=&#39;gameport&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_rawmidi&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50f20 key=&#39;snd_rawmidi&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_seq_device&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c50f78 key=&#39;snd_seq_device&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_pcm&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c51018 key=&#39;snd_pcm&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_page_alloc&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c510b0 key=&#39;snd_page_alloc&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_timer&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c51150 key=&#39;snd_timer&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c511f0 key=&#39;snd&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;soundcore&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c51288 key=&#39;soundcore&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;lp&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c512e0 key=&#39;lp&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;parport&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c51378 key=&#39;parport&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;usbhid&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c51410 key=&#39;usbhid&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;pcnet32&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c514a8 key=&#39;pcnet32&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;hid&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c514f8 key=&#39;hid&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;mptspi&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c51590 key=&#39;mptspi&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;mptscsih&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c51628 key=&#39;mptscsih&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;mptbase&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c516c8 key=&#39;mptbase&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;floppy&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c51760 key=&#39;floppy&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;vmw_pvscsi&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c517f8 key=&#39;vmw_pvscsi&#39;
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;vmxnet3&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9c51898 key=&#39;vmxnet3&#39;
Module                  Size  Used by
vmwgfx                102138  2 
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;vmwgfx&#39; found=0x9c4f088
ttm                    65344  1 vmwgfx
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;ttm&#39; found=0x9c4fec8
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;vmwgfx&#39; found=0x9c4f088
drm                   197692  3 ttm,vmwgfx
acpiphp                23535  0 
vmw_balloon            12700  0 
psmouse                72919  0 
serio_raw              13027  0 
joydev                 17393  0 
btusb                  17912  2 
nfsd                  229850  13 
i2c_piix4              13093  0 
bnep                   17830  2 
shpchp                 32325  0 
rfcomm                 38139  0 
nfs                   307376  0 
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;rfcomm&#39; found=0x9c50600
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;bnep&#39; found=0x9c504d0
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;btusb&#39; found=0x9c50300
bluetooth             158438  11 rfcomm,bnep,btusb
mac_hid                13077  0 
parport_pc             32114  1 
ppdev                  12849  0 
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;nfs&#39; found=0x9c50698
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;nfsd&#39; found=0x9c50398
nfs_acl                12771  2 nfs,nfsd
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;nfs&#39; found=0x9c50698
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;nfsd&#39; found=0x9c50398
auth_rpcgss            39597  2 nfs,nfsd
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;nfs&#39; found=0x9c50698
fscache                50642  1 nfs
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;nfs&#39; found=0x9c50698
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;nfsd&#39; found=0x9c50398
lockd                  78804  2 nfs,nfsd
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;lockd&#39; found=0x9c50b70
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;auth_rpcgss&#39; found=0x9c50a38
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;nfs_acl&#39; found=0x9c509a0
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;nfs&#39; found=0x9c50698
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;nfsd&#39; found=0x9c50398
sunrpc                205647  19 lockd,auth_rpcgss,nfs_acl,nfs,nfsd
snd_ens1371            24819  2 
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_ens1371&#39; found=0x9c50ca0
snd_ac97_codec        106082  1 snd_ens1371
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_ac97_codec&#39; found=0x9c50d40
ac97_bus               12642  1 snd_ac97_codec
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_ens1371&#39; found=0x9c50ca0
gameport               15060  1 snd_ens1371
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_ens1371&#39; found=0x9c50ca0
snd_rawmidi            25424  1 snd_ens1371
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_rawmidi&#39; found=0x9c50f20
snd_seq_device         14172  1 snd_rawmidi
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_ac97_codec&#39; found=0x9c50d40
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_ens1371&#39; found=0x9c50ca0
snd_pcm                80845  2 snd_ac97_codec,snd_ens1371
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_pcm&#39; found=0x9c51018
snd_page_alloc         14108  1 snd_pcm
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_pcm&#39; found=0x9c51018
snd_timer              28931  1 snd_pcm
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_timer&#39; found=0x9c51150
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_pcm&#39; found=0x9c51018
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_seq_device&#39; found=0x9c50f78
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_rawmidi&#39; found=0x9c50f20
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_ac97_codec&#39; found=0x9c50d40
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd_ens1371&#39; found=0x9c50ca0
snd                    62064  10 snd_timer,snd_pcm,snd_seq_device,snd_rawmidi,snd_ac97_codec,snd_ens1371
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;snd&#39; found=0x9c511f0
soundcore              14635  1 snd
lp                     17455  0 
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;lp&#39; found=0x9c512e0
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;ppdev&#39; found=0x9c50908
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;parport_pc&#39; found=0x9c50868
parport                40930  3 lp,ppdev,parport_pc
usbhid                 41906  0 
pcnet32                41110  0 
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;usbhid&#39; found=0x9c51410
hid                    77367  1 usbhid
mptspi                 22474  2 
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;mptspi&#39; found=0x9c51590
mptscsih               39530  1 mptspi
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;mptscsih&#39; found=0x9c51628
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;mptspi&#39; found=0x9c51590
mptbase                96852  2 mptscsih,mptspi
floppy                 60310  0 
vmw_pvscsi             18334  0 
vmxnet3                44924  0 
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c4f088 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c4f088 key=&#39;vmwgfx&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c4fec8 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c4fec8 key=&#39;ttm&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c4ff60 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c4ff60 key=&#39;drm&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c4fff8 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c4fff8 key=&#39;acpiphp&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50090 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50090 key=&#39;vmw_balloon&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50130 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50130 key=&#39;psmouse&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c501c8 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c501c8 key=&#39;serio_raw&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50268 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50268 key=&#39;joydev&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50300 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50300 key=&#39;btusb&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50398 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50398 key=&#39;nfsd&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50430 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50430 key=&#39;i2c_piix4&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c504d0 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c504d0 key=&#39;bnep&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50568 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50568 key=&#39;shpchp&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50600 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50600 key=&#39;rfcomm&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50698 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50698 key=&#39;nfs&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50730 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50730 key=&#39;bluetooth&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c507d0 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c507d0 key=&#39;mac_hid&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50868 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50868 key=&#39;parport_pc&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50908 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50908 key=&#39;ppdev&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c509a0 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c509a0 key=&#39;nfs_acl&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50a38 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50a38 key=&#39;auth_rpcgss&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50ad8 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50ad8 key=&#39;fscache&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50b70 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50b70 key=&#39;lockd&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50c08 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50c08 key=&#39;sunrpc&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50ca0 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50ca0 key=&#39;snd_ens1371&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50d40 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50d40 key=&#39;snd_ac97_codec&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50de0 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50de0 key=&#39;ac97_bus&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50e80 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50e80 key=&#39;gameport&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50f20 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50f20 key=&#39;snd_rawmidi&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c50f78 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c50f78 key=&#39;snd_seq_device&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c51018 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c51018 key=&#39;snd_pcm&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c510b0 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c510b0 key=&#39;snd_page_alloc&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c51150 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c51150 key=&#39;snd_timer&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c511f0 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c511f0 key=&#39;snd&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c51288 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c51288 key=&#39;soundcore&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c512e0 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c512e0 key=&#39;lp&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c51378 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c51378 key=&#39;parport&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c51410 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c51410 key=&#39;usbhid&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c514a8 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c514a8 key=&#39;pcnet32&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c514f8 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c514f8 key=&#39;hid&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c51590 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c51590 key=&#39;mptspi&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c51628 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c51628 key=&#39;mptscsih&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c516c8 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c516c8 key=&#39;mptbase&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c51760 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c51760 key=&#39;floppy&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c517f8 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c517f8 key=&#39;vmw_pvscsi&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9c51898 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9c51898 key=&#39;vmxnet3&#39;
libkmod: INFO libkmod/libkmod.c:318 kmod_unref: context 0x9c4f008 released
$ </code></pre>
<h3 id="设置日志输出级别为6">设置日志输出级别为6</h3>
<pre><code>$ export KMOD_LOG=6
$ ./tools/lsmod 
libkmod: INFO libkmod/libkmod.c:275 kmod_new: ctx 0x99cf008 created
Module                  Size  Used by
vmwgfx                102138  2 
ttm                    65344  1 vmwgfx
drm                   197692  3 ttm,vmwgfx
acpiphp                23535  0 
vmw_balloon            12700  0 
psmouse                72919  0 
serio_raw              13027  0 
joydev                 17393  0 
btusb                  17912  2 
nfsd                  229850  13 
i2c_piix4              13093  0 
bnep                   17830  2 
shpchp                 32325  0 
rfcomm                 38139  0 
nfs                   307376  0 
bluetooth             158438  11 rfcomm,bnep,btusb
mac_hid                13077  0 
parport_pc             32114  1 
ppdev                  12849  0 
nfs_acl                12771  2 nfs,nfsd
auth_rpcgss            39597  2 nfs,nfsd
fscache                50642  1 nfs
lockd                  78804  2 nfs,nfsd
sunrpc                205647  19 lockd,auth_rpcgss,nfs_acl,nfs,nfsd
snd_ens1371            24819  2 
snd_ac97_codec        106082  1 snd_ens1371
ac97_bus               12642  1 snd_ac97_codec
gameport               15060  1 snd_ens1371
snd_rawmidi            25424  1 snd_ens1371
snd_seq_device         14172  1 snd_rawmidi
snd_pcm                80845  2 snd_ac97_codec,snd_ens1371
snd_page_alloc         14108  1 snd_pcm
snd_timer              28931  1 snd_pcm
snd                    62064  10 snd_timer,snd_pcm,snd_seq_device,snd_rawmidi,snd_ac97_codec,snd_ens1371
soundcore              14635  1 snd
lp                     17455  0 
parport                40930  3 lp,ppdev,parport_pc
usbhid                 41906  0 
pcnet32                41110  0 
hid                    77367  1 usbhid
mptspi                 22474  2 
mptscsih               39530  1 mptspi
mptbase                96852  2 mptscsih,mptspi
floppy                 60310  0 
vmw_pvscsi             18334  0 
vmxnet3                44924  0 
libkmod: INFO libkmod/libkmod.c:318 kmod_unref: context 0x99cf008 released
$ </code></pre>
<h3 id="设置日志输出级别为5">设置日志输出级别为5</h3>
<pre><code>$ export KMOD_LOG=5
$ ./tools/lsmod 
Module                  Size  Used by
vmwgfx                102138  2 
ttm                    65344  1 vmwgfx
drm                   197692  3 ttm,vmwgfx
acpiphp                23535  0 
vmw_balloon            12700  0 
psmouse                72919  0 
serio_raw              13027  0 
joydev                 17393  0 
btusb                  17912  2 
nfsd                  229850  13 
i2c_piix4              13093  0 
bnep                   17830  2 
shpchp                 32325  0 
rfcomm                 38139  0 
nfs                   307376  0 
bluetooth             158438  11 rfcomm,bnep,btusb
mac_hid                13077  0 
parport_pc             32114  1 
ppdev                  12849  0 
nfs_acl                12771  2 nfs,nfsd
auth_rpcgss            39597  2 nfs,nfsd
fscache                50642  1 nfs
lockd                  78804  2 nfs,nfsd
sunrpc                205647  19 lockd,auth_rpcgss,nfs_acl,nfs,nfsd
snd_ens1371            24819  2 
snd_ac97_codec        106082  1 snd_ens1371
ac97_bus               12642  1 snd_ac97_codec
gameport               15060  1 snd_ens1371
snd_rawmidi            25424  1 snd_ens1371
snd_seq_device         14172  1 snd_rawmidi
snd_pcm                80845  2 snd_ac97_codec,snd_ens1371
snd_page_alloc         14108  1 snd_pcm
snd_timer              28931  1 snd_pcm
snd                    62064  10 snd_timer,snd_pcm,snd_seq_device,snd_rawmidi,snd_ac97_codec,snd_ens1371
soundcore              14635  1 snd
lp                     17455  0 
parport                40930  3 lp,ppdev,parport_pc
usbhid                 41906  0 
pcnet32                41110  0 
hid                    77367  1 usbhid
mptspi                 22474  2 
mptscsih               39530  1 mptspi
mptbase                96852  2 mptscsih,mptspi
floppy                 60310  0 
vmw_pvscsi             18334  0 
vmxnet3                44924  0 
$ </code></pre>
<h3 id="insmod-命令执行流程">insmod 命令执行流程</h3>
<pre><code>$ export KMOD_LOG=7
$ ./tools/insmod ../hello-module/hello.ko 
libkmod: INFO libkmod/libkmod.c:275 kmod_new: ctx 0x8b64008 created
libkmod: DEBUG libkmod/libkmod.c:276 kmod_new: log_priority=7
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;hello&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;hello&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x8b64d50 key=&#39;hello&#39;
libkmod: DEBUG libkmod/libkmod-module.c:714 kmod_module_get_path: name=&#39;hello&#39; path=&#39;/home/akaedu/Github/test-kmod-11/kmod-11/../hello-module/hello.ko&#39;
libkmod: INFO libkmod/libkmod-module.c:834 kmod_module_insert_module: Failed to insert module &#39;/home/akaedu/Github/test-kmod-11/kmod-11/../hello-module/hello.ko&#39;: Operation not permitted
insmod: ERROR: could not insert module ../hello-module/hello.ko: Operation not permitted
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x8b64d50 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x8b64d50 key=&#39;hello&#39;
libkmod: INFO libkmod/libkmod.c:318 kmod_unref: context 0x8b64008 released
$ </code></pre>
<h3 id="如果用-sudo-则必须重新传递-kmod_log7">如果用 sudo 则必须重新传递 KMOD_LOG=7</h3>
<pre><code>$ sudo KMOD_LOG=7 ./tools/insmod ../hello-module/hello.ko 
libkmod: INFO libkmod/libkmod.c:275 kmod_new: ctx 0x9ee5008 created
libkmod: DEBUG libkmod/libkmod.c:276 kmod_new: log_priority=7
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;hello&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;hello&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x9ee5088 key=&#39;hello&#39;
libkmod: DEBUG libkmod/libkmod-module.c:714 kmod_module_get_path: name=&#39;hello&#39; path=&#39;/home/akaedu/Github/test-kmod-11/kmod-11/../hello-module/hello.ko&#39;
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x9ee5088 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x9ee5088 key=&#39;hello&#39;
libkmod: INFO libkmod/libkmod.c:318 kmod_unref: context 0x9ee5008 released
$ </code></pre>
<h3 id="modinfo-命令">modinfo 命令</h3>
<pre><code>$ ./tools/modinfo ../hello-module/hello.ko 
libkmod: INFO libkmod/libkmod.c:275 kmod_new: ctx 0x90b7008 created
libkmod: DEBUG libkmod/libkmod.c:276 kmod_new: log_priority=7
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;hello&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:389 kmod_pool_get_module: get module name=&#39;hello&#39; found=(nil)
libkmod: DEBUG libkmod/libkmod.c:397 kmod_pool_add_module: add 0x90b7d50 key=&#39;hello&#39;
libkmod: DEBUG libkmod/libkmod-module.c:714 kmod_module_get_path: name=&#39;hello&#39; path=&#39;/home/akaedu/Github/test-kmod-11/kmod-11/../hello-module/hello.ko&#39;
filename:       /home/akaedu/Github/test-kmod-11/kmod-11/../hello-module/hello.ko
libkmod: DEBUG libkmod/libkmod-module.c:714 kmod_module_get_path: name=&#39;hello&#39; path=&#39;/home/akaedu/Github/test-kmod-11/kmod-11/../hello-module/hello.ko&#39;
license:        GPL
description:    module example 
author:         AKAEDU
srcversion:     49A755BEBF4FF5E99BDBD01
depends:        
vermagic:       3.2.0-29-generic-pae SMP mod_unload modversions 686 
libkmod: DEBUG libkmod/libkmod-module.c:436 kmod_module_unref: kmod_module 0x90b7d50 released
libkmod: DEBUG libkmod/libkmod.c:405 kmod_pool_del_module: del 0x90b7d50 key=&#39;hello&#39;
libkmod: INFO libkmod/libkmod.c:318 kmod_unref: context 0x90b7008 released
$ </code></pre>
<h2 id="thu-12-14-测试-alias-方式加载">THU-12-14 测试 alias 方式加载</h2>
<h3 id="编译获得内核模块hello.ko测试用">编译获得内核模块hello.ko（测试用）</h3>
<pre><code>$ ls hello-module/
hello.c   hello.mod.c  hello.o   modules.order
hello.ko  hello.mod.o  Makefile  Module.symvers
$ ls hello-module/hello.ko 
hello-module/hello.ko
$ </code></pre>
<h3 id="编写-modprobe.conf-配置文件">编写 modprobe.conf 配置文件</h3>
<pre><code>$ vi /etc/modprobe.d/modprobe.conf 
$ 此时发现权限只读，改为 sudo 方式打开
$ sudo vi /etc/modprobe.d/modprobe.conf 
$ cat /etc/modprobe.d/modprobe.conf 
alias myalias hello
$ </code></pre>
<h3 id="此时用-modprobe-加载失败">此时用 modprobe 加载，失败</h3>
<pre><code>$ ./kmod-11/tools/modprobe myalias
program_invocation_short_name = modprobe
program_invocation_name = ./kmod-11/tools/modprobe
program_invocation_short_name = bfa9463d
path is quiet
path is /lib/modules/3.2.0-29-generic-pae/modules.dep.bin
path is /lib/modules/3.2.0-29-generic-pae/modules.alias.bin
path is /lib/modules/3.2.0-29-generic-pae/modules.symbols.bin
before options args[i] = myalias
name = hello
mod = 0x8b5a148
1 name=&#39;hello&#39; path=&#39;(null)&#39;
2 name=&#39;hello&#39; path=&#39;(null)&#39;
name = hello
path = (null)
modprobe: ERROR: could not find module by name=&#39;hello&#39;
modprobe: ERROR: could not insert &#39;hello&#39;: Function not implemented
0, args[i] = myalias
$ </code></pre>
<h3 id="复制-hello.ko-到系统目录下-libmodules3.2.0-29-generic-pae">复制 hello.ko 到系统目录下 /lib/modules/3.2.0-29-generic-pae/</h3>
<pre><code>$ sudo cp ./hello-module/hello.ko /lib/modules/3.2.0-29-generic-pae/
$ ls /lib/modules/3.2.0-29-generic-pae/hello.ko 
/lib/modules/3.2.0-29-generic-pae/hello.ko
$ </code></pre>
<h3 id="此时用-modprobe-加载仍然失败">此时用 modprobe 加载，仍然失败</h3>
<pre><code>$ ./kmod-11/tools/modprobe myalias
program_invocation_short_name = modprobe
program_invocation_name = ./kmod-11/tools/modprobe
program_invocation_short_name = bf99d63d
path is quiet
path is /lib/modules/3.2.0-29-generic-pae/modules.dep.bin
path is /lib/modules/3.2.0-29-generic-pae/modules.alias.bin
path is /lib/modules/3.2.0-29-generic-pae/modules.symbols.bin
before options args[i] = myalias
name = hello
mod = 0x9a42148
1 name=&#39;hello&#39; path=&#39;(null)&#39;
2 name=&#39;hello&#39; path=&#39;(null)&#39;
name = hello
path = (null)
modprobe: ERROR: could not find module by name=&#39;hello&#39;
modprobe: ERROR: could not insert &#39;hello&#39;: Function not implemented
0, args[i] = myalias
$ </code></pre>
<h3 id="运行-depmod-命令重新生成依赖关系">运行 depmod 命令，重新生成依赖关系</h3>
<pre><code>$ sudo ./kmod-11/tools/depmod 
$ 此时识别出 hello.ko，并将它的依赖关系写入 modules.dep 文件
$ cat /lib/modules/3.2.0-29-generic-pae/modules.dep | grep hello
hello.ko:
$ </code></pre>
<h3 id="此时再用-modprobe-加载终于成功">此时再用 modprobe 加载，终于成功</h3>
<pre><code>$ sudo ./kmod-11/tools/modprobe myalias
program_invocation_short_name = modprobe
program_invocation_name = ./kmod-11/tools/modprobe
program_invocation_short_name = bfd7494c
path is quiet
path is /lib/modules/3.2.0-29-generic-pae/modules.dep.bin
path is /lib/modules/3.2.0-29-generic-pae/modules.alias.bin
path is /lib/modules/3.2.0-29-generic-pae/modules.symbols.bin
before options args[i] = myalias
name = hello

line = hello.ko:
---------------------
mod = 0x85e3148
1 name=&#39;hello&#39; path=&#39;/lib/modules/3.2.0-29-generic-pae/hello.ko&#39;
2 name=&#39;hello&#39; path=&#39;/lib/modules/3.2.0-29-generic-pae/hello.ko&#39;
path = /lib/modules/3.2.0-29-generic-pae/hello.ko
0, args[i] = myalias
$ lsmod | grep hello
hello                  12415  0 
$ </code></pre>
<h2 id="thu-12-15-测试-blacklist-方式禁止加载">THU-12-15 测试 blacklist 方式禁止加载</h2>
<h3 id="编写-modprobe.conf-配置文件-1">编写 modprobe.conf 配置文件</h3>
<pre><code>$ sudo vi /etc/modprobe.d/modprobe.conf 
$ cat /etc/modprobe.d/modprobe.conf 
alias myalias hello
blacklist hello 
$ </code></pre>
<h3 id="重新用-modprobe-加载失败">重新用 modprobe 加载，失败</h3>
<pre><code>$ sudo ./kmod-11/tools/modprobe myalias 
program_invocation_short_name = modprobe
program_invocation_name = ./kmod-11/tools/modprobe
program_invocation_short_name = bfa51940
libkmod: kmod_new: ctx 0x8ab4008 created
path is quiet
path is /lib/modules/3.2.0-29-generic-pae/modules.dep.bin
path is /lib/modules/3.2.0-29-generic-pae/modules.alias.bin
path is /lib/modules/3.2.0-29-generic-pae/modules.symbols.bin
before options args[i] = myalias
0, args[i] = myalias</code></pre>
<h3 id="用-lsmod-查看没有加载成功">用 lsmod 查看没有加载成功</h3>
<pre><code>$ lsmod | grep hello
$ </code></pre>
<h3 id="重新修改-modprobe.conf-配置文件">重新修改 modprobe.conf 配置文件</h3>
<pre><code>$ sudo vi /etc/modprobe.d/modprobe.conf 
1 alias myalias hello
2 #blacklist hello </code></pre>
<h3 id="重新用-modprobe-加载成功">重新用 modprobe 加载，成功</h3>
<pre><code>$ sudo ./kmod-11/tools/modprobe myalias
program_invocation_short_name = modprobe
program_invocation_name = ./kmod-11/tools/modprobe
program_invocation_short_name = bfd7494c
path is quiet
path is /lib/modules/3.2.0-29-generic-pae/modules.dep.bin
path is /lib/modules/3.2.0-29-generic-pae/modules.alias.bin
path is /lib/modules/3.2.0-29-generic-pae/modules.symbols.bin
before options args[i] = myalias
name = hello

line = hello.ko:
---------------------
mod = 0x85e3148
1 name=&#39;hello&#39; path=&#39;/lib/modules/3.2.0-29-generic-pae/hello.ko&#39;
2 name=&#39;hello&#39; path=&#39;/lib/modules/3.2.0-29-generic-pae/hello.ko&#39;
path = /lib/modules/3.2.0-29-generic-pae/hello.ko
0, args[i] = myalias
$ lsmod | grep hello
hello                  12415  0 
$ </code></pre>
